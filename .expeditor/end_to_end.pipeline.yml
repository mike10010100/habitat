expeditor:
  secrets:
    ACCEPTANCE_HAB_AUTH_TOKEN:
      path: account/static/habitat/chef-ci
      field: scotthain-sig-key
  defaults:
    buildkite:
      timeout_in_minutes: 30
      env:
        HAB_ORIGIN: "core"
        ACCEPTANCE_HAB_BLDR_URL: "https://bldr.acceptance.habitat.sh"
        CI_OVERRIDE_CHANNEL: "DEV"
        HAB_BLDR_CHANNEL: "DEV"
        HAB_INTERNAL_BLDR_CHANNEL: "DEV"

        # HAB_LICENSE: "accept-no-persist"
        # HAB_STUDIO_SECRET_HAB_LICENSE: "accept-no-persist"

steps:
#######################################################################
# E2E
#######################################################################

  - label: "[:linux: test_hab_help_doesnt_install_hab_sup]"
    command:
      - .expeditor/scripts/setup_environment.sh DEV
      - test/end-to-end/test_hab_help_doesnt_install_hab_sup.sh /bin/hab
    expeditor:
      executor:
        docker:
          privileged: true
          propagate-environment: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux
            - HAB_BLDR_URL=$ACCEPTANCE_HAB_BLDR_URL

  - label: "[:linux: test_launcher_checks_supervisor_version]"
    command:
      - .expeditor/scripts/setup_environment.sh DEV
      - test/end-to-end/test_launcher_checks_supervisor_version.sh
    expeditor:
      executor:
        docker:
          privileged: true
          propagate-environment: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux
            - HAB_BLDR_URL=$ACCEPTANCE_HAB_BLDR_URL

  - label: "[:linux: test_launcher_exits_on_supervisor_connection_failure]"
    command:
      - .expeditor/scripts/setup_environment.sh DEV
      - test/end-to-end/test_launcher_exits_on_supervisor_connection_failure.sh
    expeditor:
      executor:
        docker:
          privileged: true
          propagate-environment: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux
            - HAB_BLDR_URL=$ACCEPTANCE_HAB_BLDR_URL

  - label: "[:linux: test_launcher_exits_on_supervisor_startup_failure]"
    command:
      - .expeditor/scripts/setup_environment.sh DEV
      - test/end-to-end/test_launcher_exits_on_supervisor_startup_failure.sh
    expeditor:
      executor:
        docker:
          privileged: true
          propagate-environment: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux
            - HAB_BLDR_URL=$ACCEPTANCE_HAB_BLDR_URL

  - label: "[:linux: test_launcher_restarts_supervisor]"
    command:
      - .expeditor/scripts/setup_environment.sh DEV
      - test/end-to-end/test_launcher_restarts_supervisor.sh
    expeditor:
      executor:
        docker:
          privileged: true
          propagate-environment: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux
            - HAB_BLDR_URL=$ACCEPTANCE_HAB_BLDR_URL

  - label: "[:linux: test_socket_file_cleanup]"
    command:
      - .expeditor/scripts/setup_environment.sh DEV
      - test/end-to-end/test_socket_file_cleanup.sh
    expeditor:
      executor:
        docker:
          privileged: true
          propagate-environment: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux
            - HAB_BLDR_URL=$ACCEPTANCE_HAB_BLDR_URL

  - label: "[:linux: test_tar_export]"
    command:
      - .expeditor/scripts/setup_environment.sh DEV
      - test/end-to-end/test_tar_export.sh core/gzip
    expeditor:
      executor:
        docker:
          privileged: true
          propagate-environment: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux
            - HAB_BLDR_URL=$ACCEPTANCE_HAB_BLDR_URL
